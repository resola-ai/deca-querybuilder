import*as G from"react";import{useContext as ce}from"react";import{standardClassnames as W,TestID as w}from"react-querybuilder";import{useRef as J}from"react";import{getParentPath as A,isAncestor as K,pathsAreEqual as T}from"react-querybuilder";var k=({path:e,canDrop:r,schema:o,useDrop:u,rules:t})=>{let l=J(null),s=(t??[])[e[e.length-1]-1],[{isOver:a,dropMonitorId:n},D]=u(()=>({accept:["rule","ruleGroup"],canDrop:d=>{let{path:p}=d;if(d&&typeof r=="function"&&!r({dragging:d,hovering:{...s,path:e,qbId:o.qbId}}))return!1;let m=A(e),b=A(p),P=e[e.length-1],g=p[p.length-1];return!(K(p,e)||T(p,e)||T(m,b)&&P-1===g||o.independentCombinators&&T(m,b)&&P===g-1)},collect:d=>({isOver:d.canDrop()&&d.isOver(),dropMonitorId:d.getHandlerId()??"",dropEffect:(d.getDropResult()??{}).dropEffect}),drop:()=>{let{qbId:d,getQuery:p,dispatchQuery:m}=o;return{type:"inlineCombinator",path:e,qbId:d,getQuery:p,dispatchQuery:m}}}),[e,o.independentCombinators]);return D(l),{dropRef:l,dropMonitorId:n,isOver:a}};import{useEffect as X,useState as Y}from"react";import"react-querybuilder";var q=e=>{let[r,o]=Y(e??null);return X(()=>{let u=!1;return r||(async()=>{let[l,s]=await Promise.all([import("react-dnd").catch(()=>null),import("react-dnd-html5-backend").catch(()=>null)]);u||l&&s&&o(()=>({...l,...s}))})(),()=>{u=!0}},[r]),r};import{useRef as U}from"react";import{getParentPath as H,isAncestor as oe,pathsAreEqual as te}from"react-querybuilder";import{findPath as Z,getParentPath as ee,insert as re}from"react-querybuilder";var h=({type:e,path:r,disabled:o,actions:u,schema:t,useDrag:l})=>l(()=>({type:e,item:()=>({...Z(r,t.getQuery()),path:r,qbId:t.qbId}),canDrag:!o,collect:s=>({isDragging:!o&&s.isDragging(),dragMonitorId:s.getHandlerId()??""}),end:(s,a)=>{let n=a.getDropResult();if(!n)return;let D=ee(n.path),d=n.path[n.path.length-1],p=n.type==="ruleGroup"?[...n.path,0]:n.type==="inlineCombinator"?[...D,d]:[...D,d+1];if(t.qbId!==n.qbId){let m=n.getQuery();m&&(n.dispatchQuery(re(m,s,p)),n.dropEffect!=="copy"&&u.onRuleRemove(s.path))}else u.moveRule(s.path,p,n.dropEffect==="copy")}}),[o,r]);var ne=["rule","ruleGroup"],O=e=>{let{path:r,rule:o,disabled:u,schema:t,actions:l,useDrag:s,useDrop:a,canDrop:n}=e,D=U(null),d=U(null),[{isDragging:p,dragMonitorId:m},b,P]=h({type:"rule",path:r,disabled:u,independentCombinators:t.independentCombinators,moveRule:l.moveRule,schema:t,actions:l,useDrag:s}),[{isOver:g,dropMonitorId:x,dropEffect:Q},E]=a(()=>({accept:ne,canDrop:c=>{if(c&&typeof n=="function"&&!n({dragging:c,hovering:{...o,path:r,qbId:t.qbId}}))return!1;if(t.qbId!==c.qbId)return!0;let i=H(r),C=H(c.path),R=r[r.length-1],v=c.path[c.path.length-1];return!(oe(c.path,r)||te(i,C)&&(R===v||R===v-1||t.independentCombinators&&R===v-2))},collect:c=>({isOver:c.canDrop()&&c.isOver(),dropMonitorId:c.getHandlerId()??"",dropEffect:(c.getDropResult()??{}).dropEffect}),drop:()=>{let{qbId:c,getQuery:i,dispatchQuery:C}=t;return{type:"rule",path:r,qbId:c,getQuery:i,dispatchQuery:C}}}),[u,t.independentCombinators,l.moveRule,r]);return b(d),P(E(D)),{isDragging:p,dragMonitorId:m,isOver:g,dropMonitorId:x,dndRef:D,dragRef:d,dropEffect:Q}};import{useRef as B}from"react";import{getParentPath as ue,isAncestor as se,pathsAreEqual as L}from"react-querybuilder";var de=["rule","ruleGroup"],S=e=>{let{disabled:r,path:o,ruleGroup:u,schema:t,actions:l,useDrag:s,useDrop:a,canDrop:n}=e,D=B(null),d=B(null),p=B(null),[{isDragging:m,dragMonitorId:b},P,g]=h({type:"ruleGroup",path:o,disabled:r,independentCombinators:t.independentCombinators,moveRule:l.moveRule,schema:t,actions:l,useDrag:s}),[{isOver:x,dropMonitorId:Q,dropEffect:E},c]=a(()=>({accept:de,canDrop:i=>{if(r||i&&typeof n=="function"&&!n({dragging:i,hovering:{...u,path:o,qbId:t.qbId}}))return!1;if(t.qbId!==i.qbId)return!0;let C=ue(i.path),R=i.path[i.path.length-1];return!(se(i.path,o)||L(o,C)&&R===0||L(o,i.path))},collect:i=>({isOver:i.canDrop()&&i.isOver(),dropMonitorId:i.getHandlerId()??"",dropEffect:(i.getDropResult()??{}).dropEffect}),drop:(i,C)=>{let{qbId:R,getQuery:v,dispatchQuery:z}=t;return C.getDropResult()??{type:"ruleGroup",path:o,qbId:R,getQuery:v,dispatchQuery:z}}}),[r,l.moveRule,o]);return o.length>0&&(P(d),g(D)),c(p),{isDragging:m,dragMonitorId:b,isOver:x,dropMonitorId:Q,previewRef:D,dragRef:d,dropRef:p,dropEffect:E}};import{createContext as le}from"react";import{defaultControlElements as pe}from"react-querybuilder";var{rule:ae,ruleGroup:ie,combinatorSelector:De}=pe,f=le({baseControls:{rule:ae,ruleGroup:ie,combinatorSelector:De}});var F=({component:e,...r})=>{let{canDrop:o,useDrop:u}=ce(f),{dropRef:t,dropMonitorId:l,isOver:s}=k({...r,component:e,useDrop:u,canDrop:o}),a=s?W.dndOver:"",n=`${W.betweenRules}${a?` ${a}`:""}`;return G.createElement("div",{key:"dnd",ref:t,className:n,"data-dropmonitorid":l,"data-testid":w.inlineCombinator},G.createElement(e,{...r,testID:w.combinators}))};import*as y from"react";import{useContext as V}from"react";import{QueryBuilderContext as I,useMergedContext as ye,usePreferAnyProp as be,usePreferProp as j}from"react-querybuilder";import*as M from"react";import{useContext as me}from"react";var N=e=>{let r=me(f),{canDrop:o,useDrag:u,useDrop:t}=r,l=!!e.parentDisabled||!!e.disabled,s=O({...e,disabled:l,useDrag:u,useDrop:t,canDrop:o}),{rule:a}=r.baseControls;return M.createElement(f.Provider,{value:r},M.createElement(a,{...e,...s}))};import*as $ from"react";import{useContext as fe}from"react";var _=e=>{let r=fe(f),{canDrop:o,useDrag:u,useDrop:t}=r,l=!!e.parentDisabled||!!e.disabled,s=S({...e,disabled:l,useDrag:u,useDrop:t,canDrop:o}),{ruleGroup:a}=r.baseControls;return $.createElement(a,{...e,...s})};var ur=e=>{let{controlClassnames:r,controlElements:o,debugMode:u,enableDragAndDrop:t,enableMountQueryChange:l,translations:s,canDrop:a}=e,n=ye({controlClassnames:r,controlElements:o,debugMode:u,enableDragAndDrop:t??!0,enableMountQueryChange:l,translations:s??{}}),{enableDragAndDrop:D}=n,d=q(e.dnd),p=D&&d?"dnd":"no-dnd";if(!D||!d)return y.createElement(I.Provider,{key:p,value:{...n,enableDragAndDrop:!1,debugMode:u}},e.children);let{DndProvider:m,HTML5Backend:b}=d;return y.createElement(m,{key:p,backend:b,debugMode:u},y.createElement(I.Provider,{key:p,value:{...n,enableDragAndDrop:D,debugMode:u}},y.createElement(Ce,{dnd:d,canDrop:a},e.children)))},Ce=e=>{let r=V(I),o=V(f),u=q(e.dnd),t=j(!1,e.debugMode,r.debugMode),l=be(void 0,e.canDrop,o.canDrop),s=j(!0,e.enableDragAndDrop,r.enableDragAndDrop),a=s&&u?"dnd":"no-dnd";if(!s||!u)return y.createElement(I.Provider,{key:a,value:{...r,enableDragAndDrop:!1,debugMode:t}},e.children);let{DndContext:n,useDrag:D,useDrop:d}=u,p={rule:e.controlElements?.rule??r.controlElements?.rule??o.baseControls.rule,ruleGroup:e.controlElements?.ruleGroup??r.controlElements?.ruleGroup??o.baseControls.ruleGroup,combinatorSelector:e.controlElements?.combinatorSelector??r.controlElements?.combinatorSelector??o.baseControls.combinatorSelector},m={...r,controlElements:{...r.controlElements,ruleGroup:_,rule:N,inlineCombinator:F}};return y.createElement(n.Consumer,{key:a},()=>y.createElement(I.Provider,{key:a,value:m},y.createElement(f.Provider,{value:{useDrag:D,useDrop:d,baseControls:p,canDrop:l}},e.children)))};export{F as InlineCombinatorDnD,ur as QueryBuilderDnD,Ce as QueryBuilderDndWithoutProvider,N as RuleDnD,_ as RuleGroupDnD,k as useInlineCombinatorDnD,q as useReactDnD,O as useRuleDnD,S as useRuleGroupDnD};
//# sourceMappingURL=react-querybuilder_dnd.production.mjs.map